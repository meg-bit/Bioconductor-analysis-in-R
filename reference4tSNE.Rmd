---
title: "Example Code for WorkStation - tSNE and simple Heatmap"
author: "Ido Sloma"
date: "8/26/2021"
output: html_document
---

## Data Download

First the full logTPM matrix and clinical data should be downloaded via the API. We will use here a local file. 
The clinical data should match the column names in the table. We should also prepere an API for the clinical table. 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(data.table)
library(plotly)
library(Rtsne)

local.tpm.path <- '/mnt/Data/RSEM/RSEM_logTPM_ChampionsOncology_2021-06-14_Symbol.csv'
clinical <- data.table::fread('/mnt/Data/wrstation/clinical.csv')


clinical <- data.table::fread('/mnt/Data/wrstation/clinical.csv')
clinical$indication <- make.names(clinical$indication)

```

We will need also to tidy our data matrix. The API should return a ready-to-go table.

```{r cars}
log.tpm <- data.table::fread(local.tpm.path, data.table = F) %>% 
  tibble::column_to_rownames('Gene')
log.tpm$V1 <- NULL
log.tpm <- round(log.tpm,3)
log.tpm[1:5,1:5]


```
Before running a tSNE we should select only the most 5000 variable genes. This will be done using median absolute deviation and select the top _n_ genes, we plot the genes means to examine the distribution of the genes. 

```{r tsne}
mad.genes <-
  apply(log.tpm,1,mad) %>% 
    sort(decreasing = T) %>% 
      names() %>% 
        head(n=5000)
  
plot_ly(alpha = 0.5) %>%        #bigger alpha = more opaque
  add_histogram(                #adds first histogram
    x = ~rowMeans(log.tpm)) %>%        #choose numeric var. for first histogram
  add_histogram(                #add second histogram
    x = ~rowMeans(log.tpm[mad.genes,])) %>%    #choose numeric var. for second histogram
  layout(barmode = "overlay") 

    
tsne.results <- 
  Rtsne::Rtsne(t(log.tpm[mad.genes,]),
               dims = 2,
               perplexity = 25,
               check_duplicates = F)

tsne.coord <- data.frame(tsne.results$Y)
colnames(tsne.coord) <- c('tsne1','tsne2')
tsne.coord$Model <- colnames(log.tpm)
tsne.coord$model_id <- as.numeric(gsub('(CTG-)(\\d{4})','\\2',tsne.coord$Model))
tsne.coord <- merge(tsne.coord,clinical, by.x='model_id',by.y = 'model_id',all.x=T)
```

## tsne Plot

Follow this we will calculate tSNE using the Rtsne package over two dimentions and perplexity = 25, this parameter can be tune later. 

**note:** If these are not installed these should first be installed inside the workstation.

We merge our results with the indication from the clinical data.
Plotly is used here to plot the tSNE results. 
```{r pressure, echo=FALSE}
plotly::plot_ly(
  tsne.coord,               #indicate the dataframe you're using
  x = ~tsne1,         #identify x variable 
  y = ~tsne2,           #identify y variable 
  text = ~Model,     #when hovering over a node will display this var.
  type = "scatter",   #makes the plot a scatterplot
  mode = "markers",   #indicates values are points (e.g. not lines)
  color = ~indication,
  #hoverinfo = 'text',
  hovertemplate = paste('<i>Model</i>: %{text}'),
  marker = list(      #chooses properties of each node
    size = 3,      #sets the size of the node equal to selected var.
    opacity = 0.9)) %>%   #the smaller opacity the more see the node
  plotly::layout(title = 'PDX Tumor Graft Database RNA-seq <br> ChampionsOncology', #names plot
         xaxis = list(showgrid = F),       #makes x gridlines
         yaxis = list(showgrid = F),
         showlegend = FALSE
         )       #makes y gridlines
```
## Heatmap

This is a case of downloading specific genes and models. We have picked here all of TGDB's Prostate models with a specific genes. We use pheatmap to plot the heatmap.  

```{r,fig.height=8,fig.width=8}

requested.genes <- c('AR','KLK3','FOLH1','NKX3-1','MYCN','NKX2-1',
                     'DLL3','DPF1','SOX2','SYP','CHGA','CHGB','SPINK1',
                     'HNF4G','HNF1A','MUC5AC','MUC5B','KRT20','PDX1',
                     'EED','EZH2','SUZ12','SMARCC1','PBRM1','SMARCA1',
                     'SMARCC2','ACTL6B','ARID1A','ARID1B','SMARCA4',
                     'SMARCD2','SMARCD1','SMARCD3','ACTL6A','SMARCB1',
                     'KDM6A','RB1','TP53','CDKN2A')
requested.models  <- c('CTG-3581','CTG-3570','CTG-3610','CTG-3537',
                       'CTG-3421','CTG-2430','CTG-3167','CTG-3337',
                       'CTG-2440','CTG-2962','CTG-2427','CTG-2428',
                       'CTG-2429','CTG-2441','CTG-3366')
brks <- seq(0,8,by = .05)
colors <- colorRampPalette(rev(c('red','orange','white','#056DF7','blue')))(length(brks))
pheatmap::pheatmap(log.tpm[requested.genes,rev(requested.models)],
                   breaks = brks,
                   color = colors,
                   cluster_rows = F,
                   cluster_cols = F,
                   cutree_cols = 3,
                   cutree_rows = 3
                   )
```
